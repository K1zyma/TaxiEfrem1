<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi Order</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,sans-serif;
    background:#f2f2f2;
}
.container { padding:16px; }
.card {
    background:white;
    border-radius:16px;
    padding:16px;
    box-shadow:0 4px 12px rgba(0,0,0,0.05);
}
input, select, textarea, button {
    width:100%;
    padding:14px;
    margin-top:12px;
    border-radius:12px;
    border:1px solid #ddd;
    font-size:15px;
}
button {
    background:#2AABEE;
    color:white;
    border:none;
    font-weight:bold;
}
.loader {
    display:none;
    margin-top:10px;
}
</style>
</head>

<body>
<div class="container">
<div class="card">

<h3>üöï –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</h3>

<input id="from" placeholder="–û—Ç–∫—É–¥–∞ (–≥–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º)">
<input id="to" placeholder="–ö—É–¥–∞ (–≥–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º)">

<!-- –í—ã–±–æ—Ä –¥–∞—Ç—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ -->
<input id="date" type="date" placeholder="–î–∞—Ç–∞ –ø–æ–µ–∑–¥–∫–∏">
<input id="time" type="time" placeholder="–í—Ä–µ–º—è –ø–æ–µ–∑–¥–∫–∏">

<!-- –í–≤–æ–¥ –º–∞—à–∏–Ω—ã -->
<input id="carChoice" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –º–æ–¥–µ–ª—å –º–∞—à–∏–Ω—ã (–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">

<!-- –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ -->
<select id="tariff">
  <option value="econom">–≠–∫–æ–Ω–æ–º</option>
  <option value="comfort">–ö–æ–º—Ñ–æ—Ä—Ç</option>
</select>

<div class="loader" id="loader">–†–∞—Å—á—ë—Ç...</div>

<input id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+7...)">
<textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>

<button onclick="sendOrder()">–ó–∞–∫–∞–∑–∞—Ç—å</button>

</div>
</div>

<script>
let tg = window.Telegram.WebApp;
tg.expand();

let distanceKM = 0;

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞
function isFullAddress(address){
    return address.split(",").length >= 2 && address.length > 10;
}

// –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (Haversine)
function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
    const dLat = (lat2-lat1) * Math.PI/180;
    const dLon = (lon2-lon1) * Math.PI/180;

    const a =
        Math.sin(dLat/2)*Math.sin(dLat/2) +
        Math.cos(lat1*Math.PI/180) *
        Math.cos(lat2*Math.PI/180) *
        Math.sin(dLon/2) *
        Math.sin(dLon/2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –∫–º
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —á–µ—Ä–µ–∑ OpenStreetMap
async function getCoords(address){
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
    const response = await fetch(url);
    const data = await response.json();
    if (data.length === 0) return null;
    return {
        lat: parseFloat(data[0].lat),
        lon: parseFloat(data[0].lon)
    };
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
async function calculateAll() {
    const from = document.getElementById("from").value;
    const to = document.getElementById("to").value;

    if (!isFullAddress(from) || !isFullAddress(to)) {
        alert("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å: –≥–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º");
        return;
    }

    document.getElementById("loader").style.display = "block";

    const fromCoords = await getCoords(from);
    const toCoords = await getCoords(to);

    if (!fromCoords || !toCoords) {
        alert("–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω");
        document.getElementById("loader").style.display = "none";
        return;
    }

    distanceKM = haversine(
        fromCoords.lat,
        fromCoords.lon,
        toCoords.lat,
        toCoords.lon
    );

    document.getElementById("loader").style.display = "none";
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
function validatePhone(phone){
    return /^\+?[0-9]{10,15}$/.test(phone);
}

async function sendOrder() {
    const phone = document.getElementById("phone").value;

    if (!validatePhone(phone)) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
        return;
    }

    await calculateAll();

    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;

    if (!date || !time) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –ø–æ–µ–∑–¥–∫–∏");
        return;
    }

    // –í–≤–æ–¥ –º–∞—à–∏–Ω—ã –∏ —Ç–∞—Ä–∏—Ñ–∞
    const carChoice = document.getElementById("carChoice").value; // –í–≤–æ–¥ –º–æ–¥–µ–ª–∏ –º–∞—à–∏–Ω—ã
    const tariff = document.getElementById("tariff").value;

    const data = {
        from: document.getElementById("from").value,
        to: document.getElementById("to").value,
        date: date,
        time: time,
        carChoice: carChoice,
        tariff: tariff,
        phone: phone,
        comment: document.getElementById("comment").value,
        distance: distanceKM,
        tg_id: tg.initDataUnsafe.user?.id,
        tg_username: tg.initDataUnsafe.user?.username
    };

    tg.sendData(JSON.stringify(data));
}
</script>
</body>
</html>
